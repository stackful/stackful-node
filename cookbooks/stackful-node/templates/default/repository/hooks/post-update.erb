#!/usr/bin/env python
from __future__ import absolute_import, division, print_function, unicode_literals
import sys, os, subprocess

def run(cmd):
    subprocess.check_call(cmd, shell=True)


params = dict(
                deployer_home="<%= node["stackful-git"]["deployer-home"] %>",
                git_dir=os.path.abspath(os.getenv("GIT_DIR")),
                app_deploy_dir="<%= node["stackful-node"]["app-home"] %>",
                app_user="<%= node["stackful-node"]["user"] %>",
                app_name="<%= node["stackful-node"]["app-name"] %>",
              )

branch = sys.argv[1].replace("refs/heads/", "")
if branch != "master":
    print("Not deploying from branches other than 'master'. Exiting...")
    sys.exit()


os.unsetenv("GIT_DIR")
deploy_cmd = "{deployer_home}/bin/deploy '{app_user}' '{app_name}' '{git_dir}' '{app_deploy_dir}'".format(**params)
run(deploy_cmd)
